<html>
    <head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-min.js"></script>
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

		<style>
			 #bids span { font-size: 32 }
			 .col-status { width: 50px; font-size: 30px }
			 .col-name { vertical-align: middle; font-size: 20px }
			 .status-text  { display: inline-block; width: 100%; text-align: center; } 
			 .number { font-size: 20px; font-weight: bold }
			 .dev-menu { float: right; }
		</style>


    </head>
    <body style='padding: 10px;'> 
		<button class='btn btn-primary' style='display:inline-block; padding: 10px' onclick='start_bid()'><i class='fa fa-lg fa-refresh'></i></button>
		
		<div id='button_area' style='display:inline-block'>
		</div>

		<table class='table table-bordered' style='margin-top: 10px; width: 250px'>
			<tbody id='devlist'>
			</body>
		</table>

		<p>spectators</p>
		<table class='table table-bordered' style='margin-top: 10px; width: 250px'>
			<tbody id='spectators'>
			</body>
		</table>

        <script>
			var app = new WebSocket("ws://vps.sonyar.info:8000/poker");

			function getCookie(name) {
			  var value = "; " + document.cookie;
			  var parts = value.split("; " + name + "=");
			  if (parts.length == 2) return parts.pop().split(";").shift();
			}

			function getParam(name) {
				name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
				var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
				return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function send(data) {
				//testing only
				
				data['poker_id'] = getParam("poker_id"); //getCookie("poker_id");
				app.send(JSON.stringify(data));
			}

			function register() {
				send({ action: 'register' });
			}

			function bid(e) {
				send({ action: 'bid', number: $(e.target).text() });
			}

			function clear() {
				send({ action: 'clear' });
			}

			function spectate() {
				send({ action: 'spectate' });
			}

			function draw_bid_buttons() {
				var bids = [1, 2, 3, 5, 8, 13];
				var button_area = $("#button_area");
				button_area.html('');
				var button_group = $("<div class='btn-group'></div>");
				button_area.append(button_group);
			
				bids.forEach(function(num) {
					button_group.append("<button class='btn btn-success'>" + num + "</button>");
				});
			}

			function start_bid() {
				clear();
			}

			$(document).ready(function() {
				$("#button_area").on('click', 'button', bid);
				draw_bid_buttons();
			});

			app.onopen = function() {
				register();
			}

			app.onmessage = function(msg) {
				var devs = JSON.parse(msg.data);
				$("#devlist").html('');
				$("#spectators").html('');

				var waiting = false;
				for (var x in devs) {
					if (devs[x][1] == 0 && devs[x][2] == 1) {
						waiting = true;
					}
				}

				if (waiting === false) {
					devs = devs.sort(function(a,b) { return b[1] - a[1]; });
				}

				for (var x in devs) {
					var name = devs[x][0];
					var num = devs[x][1];
					var status = devs[x][2];
					

					if (status == 1) {
						if (waiting && num != 0) {
							$("#devlist").append("<tr><td class='col-status bg-success'><i class='fa fa-check status-text'></i></td><td class='col-name'>" + name + "<a style='float: right' onclick='spectate()'><i class='fa fa-ellipsis-v'></i></a></td></tr>");
						}
						else if (waiting && num == 0) {
							$("#devlist").append("<tr><td class='col-status bg-info'><i class='fa fa-question status-text'></i></td><td class='col-name'>" + name + "<a style='float: right' onclick='spectate()'><i class='fa fa-ellipsis-v'></i></a></td></tr>");
						}
						else {
							$("#devlist").append("<tr><td class='col-status bg-success'><span class='number status-text'>" + num + "</span></td><td class='col-name'>" + name + "</td></tr>");
						}
					}
					else {
						$("#spectators").append("<tr><td class='col-status bg-success'><i class='fa fa-eye'></i></td><td class='col-name'>" + name + "</td></tr>");
					}
				}
			}

			function ViewModel() {
			}
			ko.applyBindings(new ViewModel());

        </script>
    </body>
</html>


